import openai
import os
import json

# Инициализируем клиента OpenAI с ключом из переменной окружения
client = openai.OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

def evaluate_service(transcript: str) -> dict:
    """
    Оценивает разговор по четырём шагам.
      1. Приветствие и представление: 0, 50 или 100 баллов.
      2. Опрос: выяснить, был ли клиент ранее (35), уточнить имя (30) и понять, интересует залог или скупка (35). Возвращается строка вида "35/30/35".
      3. Презентация договора: 0 или 100 баллов.
      4. Прощание и отработка на возврат: 0, 50 или 100 баллов.

    Функция отправляет расшифровку в модель GPT‑4o и ожидает JSON‑ответ. Если разбора JSON не происходит, возвращает нули и текст ошибки.
    :param transcript: текст разговора сотрудника с клиентом
    :return: словарь с оценками и, при ошибке, с описанием ошибки
    """
    prompt = f"""
Ты — профессиональный аудитор сервиса. Клиент отправил текстовую расшифровку разговора сотрудника с клиентом.
Твоя задача — оценить качество сервиса по следующим шагам. Оценивай по смыслу, а не только по точным фразам. Возможны разные языки: русский, казахский, английский и т.д.

Критерии:
1. Приветствие и представление: сотрудник поздоровался и при необходимости представился. 0 баллов — ничего не сказал; 50 баллов — только приветствие; 100 баллов — поздоровался и представился.
2. Опрос: выяснил, (a) бывал ли клиент ранее (35 баллов), (b) как к нему обращаться / уточнил имя (30 баллов), (c) интересует залог или скупка (35 баллов). Выведи результат как строку вида "35/30/35", где указаны баллы за каждое подусловие (используй 0, если условие не выполнено).
3. Презентация договора: сотрудник рассказал про проценты, условия и сроки займа. 100 баллов, если всё объяснил; 0 баллов, если нет.
4. Прощание и отработка на возврат: сотрудник вежливо попрощался и пригласил вернуться. 0 баллов — ничего; 50 баллов — только прощание; 100 баллов — прощание + приглашение вернуться.

Транскрипт:
\"\"\"
{transcript}
\"\"\"

Проанализируй и выведи результат строго в JSON-формате, например:
{{
    "Приветствие и представление": 100,
    "Опрос": "35/30/35",
    "Презентация договора": 100,
    "Прощание и отработка на возврат": 50
}}
Только JSON, без пояснений.
"""
    # Отправляем запрос в модель
    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "user", "content": prompt}],
        temperature=0
    )

    content = response.choices[0].message.content

    # Пытаемся разобрать ответ как JSON
    try:
        return json.loads(content)
    except Exception as e:
        # Возвращаем нули и текст ошибки, если JSON не распознан
        return {
            "Приветствие и представление": 0,
            "Опрос": "0/0/0",
            "Презентация договора": 0,
            "Прощание и отработка на возврат": 0,
            "Ошибка": f"{e}\nGPT ответил:\n{content}"
        }

